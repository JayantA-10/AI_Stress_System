{% extends "base.html" %}
{% block title %}Analytics â€” StressAI{% endblock %}
{% block content %}
<div class="container">
  <div class="page-header">
    <h1>Your Analytics</h1>
    <p>Track how your stress has changed over time to spot patterns early.</p>
  </div>

  {% if results %}

  {# â”€â”€ Summary Counts â”€â”€ #}
  <div class="grid-3" style="margin-bottom:1rem">
    <div class="card">
      <div class="card-title">Total Check-ins</div>
      <div class="stat-value">{{ results | length }}</div>
      <div class="stat-label">entries logged</div>
    </div>
    <div class="card">
      <div class="card-title">High Risk Days</div>
      <div class="stat-value" style="color:var(--high)">{{ counts.High }}</div>
      <div class="stat-label">of {{ results | length }} total</div>
    </div>
    <div class="card">
      <div class="card-title">Low Risk Days</div>
      <div class="stat-value" style="color:var(--low)">{{ counts.Low }}</div>
      <div class="stat-label">of {{ results | length }} total</div>
    </div>
  </div>

  {# â”€â”€ Charts Row â”€â”€ #}
  <div class="grid-2" style="margin-bottom:1rem">
    <div class="card">
      <div class="card-title">Stress Level Distribution</div>
      <div style="height:210px; display:flex; align-items:center; justify-content:center">
        <canvas id="donutChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Burnout Risk Over Time</div>
      <div style="height:210px; position:relative">
        <canvas id="burnoutChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:1rem">
    <div class="card-title">Model Confidence Over Time</div>
    <div style="height:190px; position:relative">
      <canvas id="confidenceChart"></canvas>
    </div>
  </div>

  {# â”€â”€ Full History Table â”€â”€ #}
  <div class="card">
    <div class="card-title">Full History</div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Stress Level</th>
          <th>Burnout Risk</th>
          <th>Confidence</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results | reverse %}
        <tr>
          <td>{{ r.created_at.strftime("%b %d, %Y") }}</td>
          <td><span class="badge badge-{{ r.stress_prediction | lower }}">{{ r.stress_prediction }}</span></td>
          <td>
            <div style="display:flex; align-items:center; gap:0.5rem">
              <div class="progress-wrap" style="width:65px">
                <div class="progress-bar pb-{{ r.stress_prediction | lower }}" style="width:{{ r.burnout_risk }}%"></div>
              </div>
              <span>{{ r.burnout_risk | int }}%</span>
            </div>
          </td>
          <td style="color:var(--muted)">{{ r.stress_confidence }}%</td>
          <td style="color:var(--muted); font-size:0.8rem; max-width:240px">{{ r.suggested_action }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    const chartData = {{ chart_data | tojson }};
    const counts    = {{ counts    | tojson }};

    // Donut
    new Chart(document.getElementById('donutChart'), {
      type: 'doughnut',
      data: {
        labels: ['High', 'Moderate', 'Low'],
        datasets: [{ data: [counts.High, counts.Moderate, counts.Low],
          backgroundColor: ['#c0392b','#c47c20','#2d8a4e'], borderWidth: 0, hoverOffset: 5 }]
      },
      options: { cutout: '65%', plugins: { legend: { position: 'right',
        labels: { font: { family: 'DM Sans', size: 12 }, padding: 10 } } } }
    });

    // Burnout line
    new Chart(document.getElementById('burnoutChart'), {
      type: 'line',
      data: {
        labels: chartData.dates,
        datasets: [{ label: 'Burnout Risk %', data: chartData.burnout,
          borderColor: '#c0392b', backgroundColor: 'rgba(192,57,43,0.07)',
          borderWidth: 2, pointRadius: 4, tension: 0.3, fill: true }]
      },
      options: {
        scales: {
          y: { min: 0, max: 100, ticks: { callback: v => v + '%' }, grid: { color: '#e2ddd6' } },
          x: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
      }
    });

    // Confidence line
    new Chart(document.getElementById('confidenceChart'), {
      type: 'line',
      data: {
        labels: chartData.dates,
        datasets: [{ label: 'Confidence %', data: chartData.confidence,
          borderColor: '#3b6bba', backgroundColor: 'rgba(59,107,186,0.07)',
          borderWidth: 2, pointRadius: 4, tension: 0.3, fill: true }]
      },
      options: {
        scales: {
          y: { min: 0, max: 100, ticks: { callback: v => v + '%' }, grid: { color: '#e2ddd6' } },
          x: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
      }
    });
  </script>

  {% else %}
  <div class="card empty-state">
    <div class="icon">ðŸ“ˆ</div>
    <h3>No analytics yet</h3>
    <p>Log at least one check-in to see your trends here.</p>
    <a href="{{ url_for('daily_form') }}" class="btn btn-primary">Log Today's Data</a>
  </div>
  {% endif %}

</div>
{% endblock %}